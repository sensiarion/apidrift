<style>
    .grouped-section {
        margin-top: 24px;
        margin-bottom: 32px;
    }

    .grouped-changes {
        margin-top: 8px;
    }

    .grouped-card {
        background: white;
        border-radius: 6px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: opacity 0.3s, transform 0.3s;
    }

    .grouped-card.filtered-out {
        display: none;
    }

    .grouped-header {
        padding: 14px 16px;
        border-left: 3px solid #49cc90;
        cursor: pointer;
        transition: background-color 0.15s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .grouped-header:hover {
        background-color: #f5f7fa;
    }

    .grouped-header.breaking {
        border-left-color: #f93e3e;
    }

    .grouped-header.warning {
        border-left-color: #f7981c;
    }

    .grouped-header.change {
        border-left-color: #49cc90;
    }

    .grouped-change-description {
        font-weight: 500;
        color: #1f2937;
        font-size: 0.875rem;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .grouped-change-description .change-emoji {
        font-size: 1.1rem;
    }

    .count-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: 600;
        background-color: #e2e8f0;
        color: #475569;
        margin-left: 8px;
    }

    .count-badge.route-badge {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .grouped-body {
        padding: 12px 16px 16px 16px;
        display: none;
    }

    .grouped-card.expanded .grouped-body {
        display: block;
    }

    .grouped-card.expanded .toggle-icon {
        transform: rotate(90deg);
    }

    .schema-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
        margin-bottom: 8px;
    }

    .schema-chip {
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        padding: 4px 10px;
        font-size: 0.75rem;
        font-weight: 500;
        color: #334155;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    .schema-chip:hover {
        background: #e2e8f0;
        border-color: #94a3b8;
    }

    .schema-chip-link {
        text-decoration: none;
        display: inline-block;
    }

    .schema-chip-active {
        border-color: #3b82f6;
        background: #eff6ff;
        color: #1e40af;
    }

    .schema-chip-active:hover {
        background: #dbeafe;
        border-color: #2563eb;
        transform: translateY(-1px);
    }

    .route-chip {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
    }

    .route-chip:hover {
        background: #fde68a;
        border-color: #d97706;
    }

    .usage-emoji {
        margin-right: 4px;
        font-size: 0.8rem;
    }

    .schema-chip-no-changes {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #94a3b8;
        opacity: 0.7;
        cursor: not-allowed;
    }

    .difference {
        margin-bottom: 6px;
        padding: 8px 10px;
        background-color: #f9fafb;
        border-radius: 4px;
        border-left: 2px solid #49cc90;
    }

    .difference.breaking {
        border-left-color: #f93e3e;
        background-color: #fef2f2;
    }

    .difference.warning {
        border-left-color: #f7981c;
        background-color: #fffbeb;
    }

    .difference.change {
        border-left-color: #49cc90;
        background-color: #f0fdf4;
    }

    .difference-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .difference-description {
        font-weight: 500;
        color: #1f2937;
        font-size: 0.8rem;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    .property-cards {
        margin-left: 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
    }

    .property-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #475569;
    }

    .property-card .property-emoji {
        font-size: 0.8rem;
        flex-shrink: 0;
    }

    .property-card .property-type {
        font-weight: 600;
        color: #64748b;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .property-card .property-content {
        color: #1e293b;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 0.7rem;
    }
</style>

{% if data.grouped_changes | length > 0 %}
<div class="grouped-section">
    <h2 class="section-title">üìä Brief Changes</h2>
    <div class="grouped-changes">
        {% for change in data.grouped_changes %}
        <div class="grouped-card" data-change-level="{{ change.change_level_class }}">
            <div class="grouped-header {{ change.change_level_class }}">
                <div class="grouped-change-description">
                    <span class="toggle-icon">‚ñ∂</span>
                    {% if change.is_schema_grouped %}
                    {# Schema-grouped: show schema name with change count #}
                    <span class="change-emoji">{{ change.emoji }}</span>
                    <span>{{ change.description }}</span>
                    <span class="count-badge">{{ change.changes | length }} changes</span>
                    {% if change.route_names | length > 0 %}
                    <span class="count-badge route-badge">{{ change.route_names | length }} routes</span>
                    {% endif %}
                    {% else %}
                    {# Change-grouped: show change description with schema count #}
                    {% if change.is_route_change %}
                    <span class="change-emoji">üõ£Ô∏è</span>
                    {% else %}
                    <span class="change-emoji">üîß</span>
                    {% endif %}
                    <span>{{ change.description }}</span>
                    <span class="count-badge">{{ change.schema_names | length }} {% if change.is_route_change %}routes{% else %}schemas{% endif %}</span>
                    {% if not change.is_route_change and change.route_names | length > 0 %}
                    <span class="count-badge route-badge">{{ change.route_names | length }} routes</span>
                    {% endif %}
                    {% endif %}
                </div>
                <span class="badge {{ change.change_level_class }}" onclick="event.stopPropagation(); filterByChangeLevel('{{ change.change_level_class }}')">{{ change.change_level }}</span>
            </div>
            <div class="grouped-body">
                {% if change.is_schema_grouped %}
                {# For schema-grouped, show list of changes #}
                <div style="display: grid; gap: 6px; margin-bottom: 12px;">
                    {% for item in change.changes %}
                    <div class="difference {{ item.change_level_class }}">
                        <div class="difference-header">
                            <span class="difference-description">
                                <span style="margin-right: 6px;">{{ item.emoji }}</span>
                                {{ item.description }}
                            </span>
                            <span class="badge {{ item.change_level_class }}">{{ item.change_level }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                {# For change-grouped, show details if any #}
                {% if change.details | length > 0 %}
                <div class="property-cards">
                    {% for detail in change.details %}
                    <div class="property-card">
                        <span class="property-emoji">{{ detail.emoji }}</span>
                        <span class="property-type">{{ detail.property_type }}</span>
                        <span class="property-content">{{ detail.content }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endif %}
                
                {# Schema chips section #}
                <div class="schema-chips">
                    {% if change.is_schema_grouped and change.schema_name %}
                    {# Show schema link for schema-grouped changes #}
                    <a href="#schema-{{ change.schema_name }}" class="schema-chip schema-chip-link" onclick="expandAndBlink(this)">{{ change.schema_name }}</a>
                    {% else %}
                    {# Show all schema names for grouped changes #}
                    {% for schema_name in change.schema_names %}
                    {% if change.is_route_change %}
                    <a href="#route-{{ schema_name | replace(from=' ', to='-') }}" class="schema-chip schema-chip-link" onclick="expandAndBlink(this)">{{ schema_name }}</a>
                    {% else %}
                    <a href="#schema-{{ schema_name }}" class="schema-chip schema-chip-link" onclick="expandAndBlink(this)">{{ schema_name }}</a>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
                
                {# Route chips section #}
                {% if change.route_schema_usage | length > 0 %}
                <div class="schema-chips">
                    {% for usage in change.route_schema_usage %}
                    <a href="#route-{{ usage.route_name | replace(from=' ', to='-') }}" class="schema-chip schema-chip-link route-chip" onclick="expandAndBlink(this)" title="{{ usage.usage_type | capitalize }} schema">
                        <span class="usage-emoji">{{ usage.emoji }}</span>{{ usage.route_name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
    // Click on grouped header to expand/collapse
    document.querySelectorAll('.grouped-header').forEach(header => {
        header.addEventListener('click', function(e) {
            // Don't toggle if clicking on a badge
            if (e.target.classList.contains('badge')) return;
            const card = this.closest('.grouped-card');
            card.classList.toggle('expanded');
        });
    });
</script>

